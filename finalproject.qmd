---
title: "Final Project"
author: "Christina Yu, Damian Kim"
format: pdf
---


## Read in the data

```{r read-data}
library(tidyverse) 
library(ggfortify)
library(knitr)
library(broom)
library(patchwork)
library(tidymodels)
library(corrplot)
data <- read_csv("data/movies.csv")
```

## Introduction and data

Nowadays, movie industries are definitely one of the most popular things for people, especially movie investors to look at.  There are more factors that intervene in this
kind of thing, like actors, genres, user ratings and more

This dataset was scraped from IMDb (Internet Movie Database). There are 6820 movies in the dataset (220 movies per year, 1986-2016). Each movie has the following attributes:

-- `budget`: the budget of a movie. Some movies don't have this, so it appears as 0

-- `company`: the production company

-- `director`: the director

-- `genre`: main genre of the movie.

-- `gross`: revenue of the movie

-- `name`: name of the movie

-- `rating`: rating of the movie (R, PG, etc.)

-- `released`: release date (YYYY-MM-DD)

-- `runtime`: duration of the movie

--  `score`: IMDb user rating

-- `votes`: number of user votes

-- `star`: main actor/actress

-- `writer`: writer of the movie

-- `year`: year of release

We will explore the factors that make a movie successful through examining the effects of `gross`, `budget`, `genre`, `rating`,`score` `votes`, `year`, and `runtime` for individual movie. 

Since the dataset includes movies that are not missing or not published yet (therefore their gross values are missing), we filtered the dataset to include only observations with gross values not being NULL, as it does not make sense to include the movies that are not actually performed or lost real data in our analysis. We filter all the null values for the rest of predictor variables as well, since we decided that since we were working with such a large number of movies, that it was reasonable to get rid of movies that were missing some variable, for convenience of model-fitting. Now we have 5423 observations in the dataset.

```{r filter-data}
data <- data %>%
  filter(!is.na(gross) & !is.na(budget) & !is.na(genre) & !is.na(rating) & !is.na(score) & !is.na(votes) & !is.na(year) & !is.na(runtime) & !is.na(country))
```

## The Predictor Variables
We will use `budget`, `genre`, `rating`,`score` `votes`, `year`, and `runtime` as predictors. Among them, `budget`, `score` `votes`, `year`, and `runtime` are numerical variables, while `genre`and `rating` is a categorical variable.

## The Response Variable
1. Summary of the `gross` variable: 
```{r vis-gross}
data %>% 
  summarise(mean_gross = mean(gross),
            median_gross = median(gross),
            sd_gross = sd(gross),
            min_gross = min(gross),
            max_gross = max(gross)) %>% 
  kable()
```


2. Log-transformation and Distribution of the `gross` variable: 
```{r distribution-gross}
data <- data %>% 
  mutate(log_gross = log(gross)) %>%
  mutate(mean = mean(log_gross)) 

p1 <- ggplot(data = data, aes(x = gross))+
  geom_histogram(fill = "light blue", color = "black")+
  labs(title = "Distribution of Movies' Gross",
       x = "Gross")
p2 <- ggplot(data = data, aes(x = log_gross))+
  geom_histogram(fill = "light blue", color = "black")+
  labs(x = "Log (Gross)")
p1/p2

```
```{r gross-distributions, message = F, warning = F}
ggplot(data = data) + 
  geom_boxplot(aes(y = gross, color = genre)) +
  labs(title = "Gross", 
       color = "Genre")

ggplot(data = data) + 
  geom_boxplot(aes(y = log_gross, color = genre)) +
  labs(title = "Log Gross", 
       color = "Genre")
```


Since the response variable is significantly right skewed, we apply a log-transformation to it and will use log(gross) as our new response variable in the future analysis. Now, our response variable is unimodal, roughly a normal distribution, with the mean at 17.2102, and several outliers at left tail

keep the original graph for gross. XX genre has the most movies / some outliers a lot of movie

3. Relationship between Gross and Budget based on different Genres & Ratings: 
```{r relationship-gross-budget-genres, message = F, warning = F}
ggplot(data = data, aes(x=budget, y = gross, color = rating))+
  geom_point(size=0.5, fill=NA) +
  geom_smooth(fill=NA) +
  theme(legend.key.size = unit(0.3, "cm")) +
  facet_wrap(~ genre)+
  ggtitle("Relationship between Budget and Gross by Rating across Genres") +
  xlab("Budget") +
  ylab("Gross")+
  scale_color_discrete(name = "Rating", guide = guide_legend(override.aes = list(size = 1)))+
  theme(panel.spacing.x = unit(2, "mm"))
```
We observe that the relationship between budget and gross is vastly different across genres: Action, adventure, animation movies have a steep slope and generally high budget spans, with outliers which have exceedingly high budget and relatively high gross values. On the other hand, genres such as horror, mystery and romance have a much flatter slope, which corresponds to the industry knowledge that certain genres are more conducive to low-budget film making than others. Therefore, we're interested in further exploring the relationship between budget, genre, and our response variable.

## EDA: Visualizatioins and Summary Statistics
Since the dataset contains many interesting variables that we want to explore. We first do some EDA on our datasets to show potential problems that we can explore further into. 

```{r numeric-variable-distributions, message = F, warning = F}
ggplot(data = data) + 
  geom_boxplot(aes(y = year, color = genre)) +
  labs(title = "Year", 
       color = "Genre")

ggplot(data = data) + 
  geom_boxplot(aes(y = score, color = genre)) +
  labs(title = "Score", 
       color = "Genre")

ggplot(data = data) + 
  geom_boxplot(aes(y = votes, color = genre)) +
  labs(title = "Votes", 
       color = "Genre")

ggplot(data = data) + 
  geom_boxplot(aes(y = budget, color = genre)) +
  labs(title = "Budget", 
       color = "Genre")

ggplot(data = data) + 
  geom_boxplot(aes(y = runtime, color = genre)) +
  labs(title = "Runtimes", 
       color = "Genre")

```
XXX can keep the interesting observations here. we can say that runtime across all the genress are similar around 100 -- no need to include the plot -- need to focus on relationship between response and predictor 

```{r interesting-relationships, message = F, warning = F}
data2 <- data %>% 
  mutate(log_votes = log(votes)) 

ggplot(data = data, aes(x = budget, y = gross)) + 
  geom_point() +
  labs(title = "Runtime has no relationship with Gross")

data2 <- data %>% 
  mutate(log_votes = log(votes)) 

ggplot(data = data2, aes(x = runtime, y = gross)) + 
  geom_point() +
  labs(title = "Log of votes has a converging, positive relationship with Score")
```

```{r correlation-matrix, message = F, warning = F}

numeric_data <- data |> 
  select("score", "votes", "budget", "gross", "runtime")
corrplot(cor(numeric_data))

```
As can be seen, we have some correlated variables between our predictor variables, but none are particularly strong (0.8+) so we don't have to remove any of these predictor variables on the basis of correlation for our later models. 

## Methodology

As a potential movie investor, we're curious about the prediction of movies' gross based on all the variables we're interested in. We're very curious about the factors that affect success(gross) of the movie. Therefore, we want to explore the following subquestions in order for us to gain a better understanding of 1) Prediction of movies' gross value; and 2) the factors that affect the success of the movie. We choose to apply linear regression, Residual Plots, linear mixed models, LASSO, Repeated k-fold validation, and Missing Data analysis for further data analysis.

## LASSO (Variable Selection):
Since we're quite interested in the above variables as we just mentioned, but it's lack of technical proof to show that our selected variables indeed can lead to further data exploration. Therefore, we apply LASSO here as the variable selection process to see whether we con continue with our selected variables. 
```{r lasso, message = F, warning = F}
set.seed(919)
library(glmnet)
y <- data$log_gross
x <- model.matrix(log_gross ~ budget + genre + rating + score + votes + year + runtime + country, data = data)

m_lasso_cv <- cv.glmnet(x, y, alpha = 1)
best_lambda <- m_lasso_cv$lambda.min
best_lambda

m_best <- glmnet(x, y, alpha = 1, lambda = best_lambda)
m_best$beta
```

Explanation for LASSO: Based on this, dot means that those doesn't have a significant effect XXX. Put LASSO above -- this is variable selection -- we basically could say that because XXX these variables have coefficient -- we keep these variables as our predictors. 

## Linear Regression of all variables
Since it's obvious that our data has a continuous response, we'll not use logistic or ordinal regression here or multinomial regression. Therefore, we gonna use linear regression for our model. Based on the above violations, we want to first apply linear regression model to our datasets to further explore our questions. We've gained the equation of XX.  

```{r linear-regression-variables, message = F, warning = F}
m1 <- lm(log_gross ~ log(budget) + genre + rating + log(score) + log(votes) + year + log(runtime) + country, data = data)
m1_aug <- augment(m1)
summary(m1)
```

## Residual plots/Assumptions
```{r residual-plot, message = F, warning = F}
ggplot(m1_aug, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "darkred") + 
  labs(x = "Fitted (predicted) value", y = "Residual") + 
  theme_bw()

ggplot(m1_aug, aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line() + 
  theme_bw() + 
  labs(x = "Theoretical quantiles", 
       y = "Sample quantiles")
```
We may assume that each movie is independent of each other. We can see that the linear assumption is violated since the data is not symmetrically distributed observations around the horizontal axis. The linearity, constant variance, and  normality is not satisfied from the above graph. In order to address the normality violation, we did log transformation for our response variable to be `log_gross`. In order to address this problem, we use log transformation to our numeric variabls, and in this way, the linearity residual plot is improved, while the constant variance and normality is still violated. 

We acknowledge it --  limitations XXX

## Linear Mixed Model & Random Effect
Since we have the country, genre, and rating these three categorical variables have too many levels, for example, for United States, we have XXX data records, and for XX country, we only have XX variables, so it would make more sense for use to use these three varaibels as random effects, we want to apply linear mixed model to our datasets to further explore our questions. We want to look at the associations between our interested variables, and random effect due to country, genre, and rating.

```{r random-effect, message = F, warning = F}
library(lme4)
m4 <- lm(log_gross ~ budget + genre + rating + score + votes + year + runtime + country, data = data)
m5 <- lmer(log_gross ~ 1 + budget + (1 | genre) + (1 | rating) + score + votes + year + runtime + (1 | country), data = data)
summary(m4)$coef
summary(m5)
```
While adjusting for the random intercept based on country variable and holding all other variables constant, we noticed that the estimated variance is 0.1623 which means that all the country-specific intercept is distributed around the model's overall intercept within estimated variance of 0.1623, given that our unit is log dollars, and our estimated variance is quite small, we may expect that the country is similar. In terms of our interest in knowing whether a movie is successful or not, production of country may not be a big effect on the movie's success.

Since we noticed that genre has the smallest estimated variance (0.08254), we may say that compared to the difference between ratings and countries, the difference between genres is smaller, while rating has the biggest difference. Given that our unit is log dollars, and all of our estimated variance is quite small, the differences between these variables should be similar to each other. 

## Interested Hypothesis Test 1:
Question 1: Is there evidence to suggest that log(Budget) has an effect on the success of the movies?
Null hypothesis: $p_1 = 0$ There isn't sufficient evidence to suggest that budget is associated with movies' gross, while controlling for all of the variables.
Alternative hypothesis: $p_1 ≠ 0$ There is sufficient evidence to suggest that budget is associated with movies' gross, while controlling for all of the variables.

We use significance level of 0.05. Since the t-statistics is 23.227 and the p-value is < 2e-16 which is much smaller than our significance level, so we reject the null hypothesis since there's sufficient evidence, and thus there's sufficient evidence to suggest to log(budget) does have an effect on the success of the movies (log(gross)).

In terms of qualitatively addressing this issue: in our model, we know that every $1$ million increase in our budget, the gross value is expected to increase by $e^{cc}$ dollars.
## Interested Hypothesis Test 2:
Aim 2: Is there evidence to suggest that log(Score) has an effect on the success of the movies?
Null hypothesis:  $p_2 = 0$ There isn't sufficient evidence to suggest that Score is associated with movies' gross, while controlling for all of the variables.
Alternative hypothesis: $p_2 ≠ 0$ There is sufficient evidence to suggest that Score is associated with movies' gross, while controlling for all of the variables.

We use significance level of 0.05. Since the t-statistics is 23.227 and the p-value is 3.06e-09 which is much smaller than our significance level, so we reject the null hypothesis since there's sufficient evidence, and thus there's sufficient evidence to suggest to genre does have an effect on the success of the movies. 

## Summary based on Hypothesis: 
Based on our previous two hypothesis, we noticed that XXXXX. 


## Predicting moves' gross
Based on all the models we've done above, we've analyzed the relationship between different variables that we're interested in. In order to make our findings applicable for future use, we'd like to make a prediction on movies' gross based on our current variables. 

```{r prediction-gross, message = F, warning = F}
set.seed(123)
dim(data)

indices <- sample(1:5423, size = 5423 * 0.8, replace = F)
train.data  <- data %>% 
  slice(indices)
test.data <- data %>% 
  slice(-indices)
dim(train.data)

library(caret)
cv_method <- trainControl(method = "cv", number = 10,
                          repeats = 5)
m1 <- train(log_gross ~ budget + genre + rating + score + votes + year + runtime + country, data = data, method = "lm", trControl = cv_method)
m2 <- train(log_gross ~ budget + genre + rating + score + votes + year + runtime + country, data = data, method = "lm", trControl = cv_method)

print(m2)

library(caret)
cv_method <- trainControl(method = "cv", number = 10,
                          repeats = 5)
m3 <- train(log_gross ~ log(budget) + genre + rating + log(score) + log(votes) + year + log(runtime) + country, data = data, method = "lm", trControl = cv_method)
m4 <- train(log_gross ~ log(budget) + genre + rating + log(score) + log(votes) + year + log(runtime) + country, data = data, method = "lm", trControl = cv_method)

print(m4)
```

The RMSE from first model is XXX; while the RMSE from the second model is XXXX. Since the second one is smaller, the second one is better performing model in predicting the gross values of the movie. XXXX Since better, we might use log/ or fewer variables in predicting our gross values. 

## Missing Data Analysis:

XXXX

## Results
Explain the reasoning for the type of model you’re fitting, predictor variables considered for the model including any interactions. Additionally, show how you arrived at the final model by describing the model selection process, interactions considered, variable transformations (if needed), assessment of conditions and diagnostics, and any other relevant considerations that were part of the model fitting process.

## Discussion & Limitations 
Summary + statistical arguments to support my conclusions + future limitations/future ideads